apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "jupyterhub.hub.fullname" . }}
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "jupyterhub.matchLabels" . | nindent 6 }}
  strategy:
    {{- .Values.hub.deploymentStrategy | toYaml | nindent 4 }}
  template:
    metadata:
      labels:
        {{- /* Changes here will cause the Deployment to restart the pods. */}}
        {{- include "jupyterhub.matchLabels" . | nindent 8 }}
        hub.jupyter.org/network-access-proxy-api: "true"
        hub.jupyter.org/network-access-proxy-http: "true"
        hub.jupyter.org/network-access-singleuser: "true"
        {{- with .Values.hub.labels }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
      annotations:
        {{- /* This lets us autorestart when the secret changes! */}}
        checksum/config-map: {{ include (print .Template.BasePath "/hub/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print .Template.BasePath "/hub/secret.yaml") . | sha256sum }}
        {{- with .Values.hub.annotations }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/port: "9000"
    spec:
      {{- if .Values.scheduling.podPriority.enabled }}
      priorityClassName: {{ include "jupyterhub.priority.fullname" . }}
      {{- end }}
      nodeSelector: {{ toJson .Values.hub.nodeSelector }}
      {{- with concat .Values.scheduling.corePods.tolerations .Values.hub.tolerations }}
      tolerations:
        {{- . | toYaml | nindent 8 }}
      {{- end }}
      {{- include "jupyterhub.coreAffinity" . | nindent 6 }}
      volumes:
        - name: config
          configMap:
            name: {{ include "jupyterhub.hub.fullname" . }}
        - name: secret
          secret:
            secretName: {{ include "jupyterhub.hub.fullname" . }}
        {{- with (include "jupyterhub.hub-existing-secret.fullname" .) }}
        - name: existing-secret
          secret:
            secretName: {{ . }}
        {{- end }}
        {{- if .Values.hub.extraFiles }}
        - name: files
          secret:
            secretName: {{ include "jupyterhub.hub.fullname" . }}
            items:
              {{- range $file_key, $file_details := .Values.hub.extraFiles }}
              - key: {{ $file_key | quote }}
                path: {{ $file_key | quote }}
                {{- with $file_details.mode }}
                mode: {{ . }}
                {{- end }}
              {{- end }}
        {{- end }}
        {{- with .Values.hub.extraVolumes }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
        {{- if eq .Values.hub.db.type "sqlite-pvc" }}
        - name: pvc
          persistentVolumeClaim:
            claimName: {{ include "jupyterhub.hub-pvc.fullname" . }}
        {{- end }}
        {{- if .Values.schedulableNotebook.enabled }}
        - name: jenkins-dir
          persistentVolumeClaim:
            claimName: jenkins-settings-dir
        - name: home-dir
          persistentVolumeClaim:
            claimName: schedulable-notebook-home-dir
        {{- end }}
      {{- if .Values.rbac.enabled }}
      serviceAccountName: {{ include "jupyterhub.hub.fullname" . }}
      {{- end }}
      securityContext:
        fsGroup: {{ .Values.hub.fsGid }}
      {{- with include "jupyterhub.imagePullSecrets" (dict "root" . "image" .Values.hub.image) }}
      imagePullSecrets: {{ . }}
      {{- end }}
      {{- with .Values.hub.initContainers }}
      initContainers:
        {{- . | toYaml | nindent 8 }}
      {{- end }}
      containers:
        {{- with .Values.hub.extraContainers }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}

        {{- if .Values.schedulableNotebook.enabled }}
        - command:
          - jupyterhub-singleuser
          env:
          - name: SLACK_API_URL
            value: {{ .Values.schedulableNotebook.slack.apiURL | quote }}
          - name: SLACK_API_TOKEN
            value: {{ .Values.schedulableNotebook.slack.apiToken | quote }}
          - name: SLACK_CHANNEL
            value: {{ .Values.schedulableNotebook.slack.channel | quote }}
          - name: TZ
            value: {{ .Values.schedulableNotebook.timezone | quote }}
          - name: PROMETHEUS_SNAPSHOT_PATH
            value: {{ .Values.schedulableNotebook.prometheus.snapshotPath | quote }}
          - name: GCS_BUCKET
            valueFrom:
              secretKeyRef:
                {{- if .Values.hub.existingSecret }}
                name: {{ .Values.hub.existingSecret }}
                {{- else }}
                name: hub
                {{- end }}
                key: gcs.bucketName
          - name: PROMETHEUS_HOST
            value: {{ .Values.schedulableNotebook.prometheus.host | quote }}
          - name: PROMETHEUS_PORT
            value: {{ .Values.schedulableNotebook.prometheus.port | quote }}
          - name: PROMETHEUS_NAMESPACE
            value: {{ .Values.schedulableNotebook.prometheus.podNamespace | quote }}
          - name: PROMETHEUS_CONTAINER
            value: {{ .Values.schedulableNotebook.prometheus.container | quote }}
          - name: PROMETHEUS_DEPLOYMENT
            value: {{ .Values.schedulableNotebook.prometheus.deployment }}
          - name: JUPYTERHUB_CLIENT_ID
            value: service-schedulable-notebook
          - name: JUPYTERHUB_SERVICE_PREFIX
            value: /services/schedulable-notebook/
          - name: JUPYTERHUB_ADMIN_ACCESS
            value: "True"
          - name: JUPYTERHUB_API_TOKEN
            valueFrom:
              secretKeyRef:
                {{- if .Values.hub.existingSecret }}
                name: {{ .Values.hub.existingSecret }}
                {{- else }}
                name: hub
                {{- end }}
                key: schedulable-notebook.token
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /var/secrets/googleCloudServiceAccount.json
          image: {{ .Values.schedulableNotebook.image.name }}:{{ .Values.schedulableNotebook.image.tag }}
          {{- with .Values.schedulableNotebook.image.pullPolicy }}
          imagePullPolicy: {{ . }}
          {{- end }}
          name: schedulable-notebook
          volumeMounts:
            - name: secret
              mountPath: /var/secrets
            - name: jenkins-dir
              mountPath: /home/jovyan/.jenkins
            - name: home-dir
              mountPath: /home/jovyan/
          ports:
          - containerPort: 8888
            protocol: TCP
          resources: {}
        {{- end }}
        {{- if .Values.usersExporter.enabled }}
        - name: jupyterhub-users-exporter
          image: {{ .Values.usersExporter.image.name }}:{{ .Values.usersExporter.image.tag }}
          {{- with .Values.usersExporter.image.pullPolicy }}
          imagePullPolicy: {{ . }}
          {{- end }}
          ports:
          - containerPort: 9000
            protocol: TCP
          env:
          - name: JUPYTER_HUB_HOST
            value: proxy-public.{{ .Release.Namespace }}.svc.cluster.local
          - name: JUPYTER_HUB_PORT
            value: '80'
          - name: JUPYTER_HUB_API_TOKEN
            valueFrom:
              secretKeyRef:
                {{- if .Values.hub.existingSecret }}
                name: {{ .Values.hub.existingSecret }}
                {{- else }}
                name: hub
                {{- end }}
                key: users-exporter.token
        {{- end }}
        - name: hub
          image: {{ .Values.hub.image.name }}:{{ .Values.hub.image.tag }}
          {{- with .Values.hub.command }}
          command:
            {{- range . }}
            - {{ tpl . $ }}
            {{- end }}
          {{- end }}
          args:
            {{- /* .Values.hub.args overrides everything the Helm chart otherside would set */}}
            {{- if .Values.hub.args }}
            {{- range .Values.hub.args }}
            - {{ tpl . $ }}
            {{- end }}

            {{- /* .Values.hub.args didn't replace the default logic */}}
            {{- else }}
            - jupyterhub
            - --config
            - /usr/local/etc/jupyterhub/jupyterhub_config.py
            {{- if .Values.debug.enabled }}
            - --debug
            {{- end }}
            {{- /* NOTE:
              We want to do automatic upgrades for sqlite-pvc by default, but
              allow users to opt out of that if they want. Users using their own
              db need to 'opt in' Go Templates treat nil and "" and false as
              'false', making this code complex. We can probably make this a
              one-liner, but doing combinations of boolean vars in go templates
              is very inelegant & hard to reason about.
            */}}
            {{- $upgradeType := typeOf .Values.hub.db.upgrade }}
            {{- if eq $upgradeType "bool" }}
            {{- /* .Values.hub.db.upgrade has been explicitly set to true or false */}}
            {{- if .Values.hub.db.upgrade }}
            - --upgrade-db
            {{- end }}
            {{- else if eq $upgradeType "<nil>" }}
            {{- /* .Values.hub.db.upgrade is nil */}}
            {{- if eq .Values.hub.db.type "sqlite-pvc" }}
            - --upgrade-db
            {{- end }}
            {{- end }}
            {{- end }}
          volumeMounts:
            - mountPath: /usr/local/etc/jupyterhub/jupyterhub_config.py
              subPath: jupyterhub_config.py
              name: config
            - mountPath: /usr/local/etc/jupyterhub/z2jh.py
              subPath: z2jh.py
              name: config
            - mountPath: /usr/local/etc/jupyterhub/config/
              name: config
            - mountPath: /usr/local/etc/jupyterhub/secret/
              name: secret
            {{- if (include "jupyterhub.hub-existing-secret.fullname" .) }}
            - mountPath: /usr/local/etc/jupyterhub/existing-secret/
              name: existing-secret
            {{- end }}
            {{- range $file_key, $file_details := .Values.hub.extraFiles }}
            - mountPath: {{ $file_details.mountPath }}
              subPath: {{ $file_key | quote }}
              name: files
            {{- end }}
            {{- with .Values.hub.extraVolumeMounts }}
            {{- . | toYaml | nindent 12 }}
            {{- end }}
            {{- if eq .Values.hub.db.type "sqlite-pvc" }}
            - mountPath: /srv/jupyterhub
              name: pvc
              {{- with .Values.hub.db.pvc.subPath }}
              subPath: {{ . | quote }}
              {{- end }}
            {{- end }}
          {{- with .Values.hub.resources }}
          resources:
            {{- . | toYaml | nindent 12 }}
          {{- end }}
          {{- with .Values.hub.image.pullPolicy }}
          imagePullPolicy: {{ . }}
          {{- end }}
          {{- with .Values.hub.containerSecurityContext }}
          securityContext:
            {{- . | toYaml | nindent 12 }}
          {{- end }}
          {{- with .Values.hub.lifecycle }}
          lifecycle:
            {{- . | toYaml | nindent 12 }}
          {{- end }}
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: HELM_RELEASE_NAME
              value: {{ .Release.Name | quote }}
            - name: GRAFANA_INTERNAL_HOST
              value: {{ .Values.grafana.internalHost }}
            - name: GRAFANA_EXTERNAL_HOST
              value: {{ .Values.grafana.externalHost }}
            - name: GRAFANA_API_KEY
              valueFrom:
                secretKeyRef:
                  {{- if .Values.hub.existingSecret }}
                  name: {{ .Values.hub.existingSecret }}
                  {{- else }}
                  name: hub
                  {{- end }}
                  key: grafana.apiKey
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CONFIGPROXY_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  {{- /* NOTE:
                    References the chart managed k8s Secret even if
                    hub.existingSecret is specified to avoid using the lookup
                    function on the user managed k8s Secret which is assumed to
                    not be possible.
                  */}}
                  name: {{ include "jupyterhub.hub.fullname" . }}
                  key: hub.config.ConfigurableHTTPProxy.auth_token
            {{- with .Values.hub.extraEnv }}
            {{- include "jupyterhub.extraEnv" . | nindent 12 }}
            {{- end }}
          ports:
            - name: http
              containerPort: 8081
          {{- if .Values.hub.livenessProbe.enabled }}
          {{- /* NOTE:
            We don't know how long hub database upgrades could take so having a
            liveness probe could be a bit risky unless we put a
            initialDelaySeconds value with long enough margin for that to not be
            an issue. If it is too short, we could end up aborting database
            upgrades midway or ending up in an infinite restart loop.
          */}}
          livenessProbe:
            initialDelaySeconds: {{ .Values.hub.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.hub.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.hub.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.hub.livenessProbe.failureThreshold }}
            httpGet:
              path: {{ .Values.hub.baseUrl | trimSuffix "/" }}/hub/health
              port: http
          {{- end }}
          {{- if .Values.hub.readinessProbe.enabled }}
          readinessProbe:
            initialDelaySeconds: {{ .Values.hub.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.hub.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.hub.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.hub.readinessProbe.failureThreshold }}
            httpGet:
              path: {{ .Values.hub.baseUrl | trimSuffix "/" }}/hub/health
              port: http
          {{- end }}
      {{- with .Values.hub.extraPodSpec }}
      {{- . | toYaml | nindent 6 }}
      {{- end }}
